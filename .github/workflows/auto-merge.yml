name: Auto Merge with Approval

on:
  pull_request:
    types: [opened, synchronize, review_requested, review_request_removed]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  statuses: write
  checks: write

jobs:
  auto-merge:
    name: Auto Merge Approved PRs
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || (github.event_name == 'issue_comment' && github.event.issue.pull_request)
    
    steps:
    - name: Get PR number
      id: get-pr-number
      run: |
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
        else
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check if PR is approved by admin
      id: check-approval
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        is_admin() {
          local user=$1
          local repo_owner="${{ github.repository_owner }}"
          if [ "$user" = "$repo_owner" ]; then
            return 0
          fi
          local permission=$(gh api repos/${{ github.repository }}/collaborators/$user/permission --jq '.permission' 2>/dev/null || echo "none")
          if [ "$permission" = "admin" ] || [ "$permission" = "maintain" ]; then
            return 0
          fi
          return 1
        }
        
        REVIEWS=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json reviews --jq '.reviews[] | select(.state == "APPROVED") | .author.login')
        PR_AUTHOR=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json author --jq '.author.login')
        
        APPROVED_BY_ADMIN=false
        if is_admin "$PR_AUTHOR"; then
          echo "PR author $PR_AUTHOR is an admin - self-approval allowed"
          APPROVED_BY_ADMIN=true
        else
          while IFS= read -r reviewer; do
            if [ -n "$reviewer" ] && is_admin "$reviewer"; then
              echo "Reviewer $reviewer is an admin"
              APPROVED_BY_ADMIN=true
              break
            fi
          done <<< "$REVIEWS"
        fi
        
        echo "approved_by_admin=$APPROVED_BY_ADMIN" >> $GITHUB_OUTPUT
        
    - name: Check for /approve command
      id: check-approve-command
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        is_admin() {
          local user=$1
          local repo_owner="${{ github.repository_owner }}"
          if [ "$user" = "$repo_owner" ]; then
            return 0
          fi
          local permission=$(gh api repos/${{ github.repository }}/collaborators/$user/permission --jq '.permission' 2>/dev/null || echo "none")
          if [ "$permission" = "admin" ] || [ "$permission" = "maintain" ]; then
            return 0
          fi
          return 1
        }
        
        COMMENTS_JSON=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json comments --jq '.comments[] | {author: .author.login, body: .body}')
        
        APPROVE_FOUND=false
        while IFS= read -r comment; do
          AUTHOR=$(echo "$comment" | jq -r '.author')
          BODY=$(echo "$comment" | jq -r '.body')
          if is_admin "$AUTHOR" && echo "$BODY" | grep -q "/approve"; then
            echo "Found /approve command from admin: $AUTHOR"
            APPROVE_FOUND=true
            break
          fi
        done <<< "$COMMENTS_JSON"
        
        if [ "$APPROVE_FOUND" = "true" ]; then
          echo "approve_command_found=true" >> $GITHUB_OUTPUT
        else
          echo "approve_command_found=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Check CI status
      id: check-ci
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        STATUS_CHECKS=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json statusCheckRollup --jq '.statusCheckRollup // [] | map(select(.context and (.context | test("^(Build)$")))) | map({context: .context, state: .state, conclusion: .conclusion})')
        
        CHECK_COUNT=$(echo "$STATUS_CHECKS" | jq 'length')
        if [ "$CHECK_COUNT" -eq 0 ]; then
          echo "ALL_CHECKS_PASSING=true" >> $GITHUB_OUTPUT
        else
          ALL_CHECKS_PASSING=true
          echo "$STATUS_CHECKS" | jq -r '.[] | "\(.context)|\(.state)|\(.conclusion)"' | while IFS='|' read -r context state conclusion; do
            if [ -n "$context" ] && [ "$state" != "SUCCESS" ] && [ "$conclusion" != "SUCCESS" ]; then
              echo "ALL_CHECKS_PASSING=false" >> $GITHUB_OUTPUT
            fi
          done
          if [ -z "$(grep ALL_CHECKS_PASSING $GITHUB_OUTPUT | grep false)" ]; then
            echo "ALL_CHECKS_PASSING=true" >> $GITHUB_OUTPUT
          fi
        fi
        
    - name: Create approval review for admin
      if: steps.check-approval.outputs.approved_by_admin == 'true' && steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Creating approval review as GitHub Actions bot..."
        gh pr review ${{ steps.get-pr-number.outputs.pr_number }} --approve --body "Auto-approved via /approve command" || echo "Review may already exist"
        
    - name: Auto merge if conditions met
      if: steps.check-approval.outputs.approved_by_admin == 'true' && steps.check-approve-command.outputs.approve_command_found == 'true' && steps.check-ci.outputs.ALL_CHECKS_PASSING == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üöÄ Auto-merging PR #${{ steps.get-pr-number.outputs.pr_number }}"
        sleep 5
        
        if gh pr merge ${{ steps.get-pr-number.outputs.pr_number }} --squash --delete-branch 2>&1; then
          echo "‚úÖ Merge successful"
          gh pr comment ${{ steps.get-pr-number.outputs.pr_number }} --body "‚úÖ **PR merged successfully!** Auto-merged via /approve command."
        else
          echo "‚ö†Ô∏è  Auto-merge failed - manual intervention may be required"
          gh pr comment ${{ steps.get-pr-number.outputs.pr_number }} --body "‚ö†Ô∏è **Auto-merge failed** - The PR meets all conditions but couldn't be merged automatically. Please merge manually."
        fi

